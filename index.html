<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billets Tournoi PDF - Scan Multi</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<style>
  video {
    width: 100px;
    height: 100px;
    border: 1px solid #ccc;
    border-radius: 6px;
    display: block;
    margin-top: 10px;
    margin-left: auto;
    margin-right: auto;
  }
</style>
</head>
<body class="p-3">
<div class="container">
<h2>Billets Tournoi - PDF Design Officiel + Scan Multi</h2>

<ul class="nav nav-tabs">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#emetteur">Émetteur</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#valideur">Valideur</button></li>
</ul>

<div class="tab-content mt-3">
  <div class="tab-pane fade show active" id="emetteur">
    <h4>Générer PDF de billets</h4>
    <input type="number" id="qty" class="form-control mb-2" placeholder="Nombre de billets" value="20">
    <button id="genPDF" class="btn btn-success mb-3">Générer et Télécharger PDF</button>
  </div>

  <div class="tab-pane fade" id="valideur">
    <h4>Scanner Billets</h4>
    <button class="btn btn-primary mb-2" id="startCam">Démarrer caméra</button>
    <button class="btn btn-secondary mb-2" id="stopCam" disabled>Arrêter caméra</button>
    <video id="video"></video>
    <div id="result" class="mt-2 text-center"></div>
    <h5 class="mt-3">Billets déjà utilisés :</h5>
    <ul id="usedList"></ul>
  </div>
</div>
</div>

<script>
const TOURNAMENT_NAME = "Tournois Termessé 2 -ème Edition";
let tickets = [];
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const usedList = document.getElementById('usedList');
let stream = null;
let scanInterval = null;

// --- Gestion billets utilisés ---
function getUsed(){ return JSON.parse(localStorage.getItem('usedTickets')||'[]'); }
function markUsed(id){
  const arr = getUsed();
  if(!arr.includes(id)){ arr.push(id); localStorage.setItem('usedTickets', JSON.stringify(arr)); renderUsed(); }
}
function renderUsed(){
  usedList.innerHTML = '';
  getUsed().forEach(id => {
    const li = document.createElement('li'); li.textContent = id; usedList.appendChild(li);
  });
}
renderUsed();

// --- Génération PDF ---
async function generatePDF(qty){
  const { jsPDF } = window.jspdf;
  tickets = [];
  const pdf = new jsPDF({unit:"pt", format:"a4"}); 
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();

  const margin = 30;
  const cols = 2;
  const rows = 5;
  const cellWidth = (pageWidth - margin*2) / cols;
  const cellHeight = (pageHeight - margin*2) / rows;

  let count = 0;

  for(let i=0;i<qty;i++){
    const ticketText = `${TOURNAMENT_NAME} - Billet #${i+1}`;
    tickets.push(ticketText);

    // QR code
    const canvas = document.createElement('canvas');
    await QRCode.toCanvas(canvas, ticketText, {width:100, height:100});

    const col = count % cols;
    const row = Math.floor(count / cols) % rows;
    const x = margin + col*cellWidth;
    const y = margin + row*cellHeight;

    const rectX = x + 5;
    const rectY = y + 5;
    const rectW = cellWidth - 10;
    const rectH = cellHeight - 10;

    // Fond et bordure
    pdf.setFillColor(240, 248, 255);
    pdf.roundedRect(rectX, rectY, rectW, rectH, 10, 10, 'F');
    pdf.setDrawColor(0);
    pdf.roundedRect(rectX, rectY, rectW, rectH, 10, 10, 'S');

    // QR code centré
    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', rectX + rectW/2 - 50, rectY + 10, 100, 100);

    // Texte centré
    pdf.setFontSize(12);
    pdf.setTextColor(0);
    const maxWidth = rectW - 10;
    const splitText = pdf.splitTextToSize(ticketText, maxWidth);
    const textY = rectY + rectH - 30 - (splitText.length-1)*7;
    pdf.text(splitText, rectX + rectW/2, textY, {align:"center"});

    count++;
    if(count % (cols*rows) === 0 && i<qty-1){ pdf.addPage(); count=0; }
  }

  pdf.save('billets_tournoi_officiel.pdf');
}

document.getElementById('genPDF').addEventListener('click', ()=>{
  const qty = parseInt(document.getElementById('qty').value || 20);
  generatePDF(qty);
});

// --- Scanner QR code multi ---
document.getElementById('startCam').addEventListener('click', async ()=>{
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment', width:100, height:100}});
  video.srcObject = stream; video.play();
  document.getElementById('startCam').disabled=true;
  document.getElementById('stopCam').disabled=false;

  const canvas = document.createElement('canvas'); 
  const ctx = canvas.getContext('2d');

  scanInterval = setInterval(()=>{
    if(video.readyState!==video.HAVE_ENOUGH_DATA) return;
    canvas.width = 100;
    canvas.height = 100;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if(code){
      handleScan(code.data);
    }
  },200);
});

document.getElementById('stopCam').addEventListener('click', ()=>{
  clearInterval(scanInterval);
  if(stream) stream.getTracks().forEach(t=>t.stop());
  video.srcObject=null;
  document.getElementById('startCam').disabled=false;
  document.getElementById('stopCam').disabled=true;
});

// --- Gestion scan ---
function handleScan(data){
  if(!tickets.includes(data)){
    resultDiv.innerHTML='<span style="color:red">Billet invalide !</span>';
    return;
  }
  if(getUsed().includes(data)){
    resultDiv.innerHTML='<span style="color:red">Billet déjà utilisé !</span>';
    return;
  }
  markUsed(data);
  resultDiv.innerHTML='<span style="color:green">Billet accepté !</span>';
  // Ne pas stopper le scan, continuer à scanner d'autres billets
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
