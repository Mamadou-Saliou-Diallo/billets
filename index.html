<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ARTD 3ème Édition - Billets & Scan</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<style>
body { background: #f8f9fa; }
video { width:100%; max-width:400px; height:auto; border:3px solid #198754; border-radius:10px; display:block; margin:10px auto; object-fit:cover; }
#result { font-size:1.8rem; font-weight:bold; text-align:center; margin-top:10px; }
.counter-box { background:#fff; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); padding:15px; margin-top:15px; }

/* Popup codes avec animation */
#accessPopup { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; opacity:0; transition:opacity 0.3s ease-in-out; }
#accessPopup.show { display:block; opacity:1; }
#accessPopup .popup-content { background:#fff; padding:20px; border-radius:10px; width:300px; max-width:90%; margin:100px auto; text-align:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); transform:translateY(-50px); transition:transform 0.3s ease-in-out; }
#accessPopup.show .popup-content { transform:translateY(0); }
#accessPopup input { width:80%; margin-bottom:10px; }
</style>
</head>
<body class="p-3">

<div class="container">
  <h2 class="text-center mb-4 text-success fw-bold">🎟️ Tournoi ARTD - 3ème Édition</h2>

  <ul class="nav nav-tabs justify-content-center">
    <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#emetteur">Émetteur</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#valideur">Valideur</button></li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="emetteur">
      <div class="text-center">
        <h4>Générer les billets PDF</h4>
        <input type="number" id="qty" class="form-control mb-2 w-50 mx-auto" placeholder="Nombre de billets" value="20">
        <button id="genPDF" class="btn btn-success mb-3">🔐 Générer & Télécharger PDF</button>
      </div>
    </div>

    <div class="tab-pane fade" id="valideur">
      <div class="text-center">
        <h4>Scanner les billets</h4>
        <button class="btn btn-primary mb-2" id="startCam">🎥 Démarrer caméra</button>
        <button class="btn btn-danger mb-2" id="stopCam" disabled>🛑 Arrêter caméra</button>
      </div>
      <video id="video"></video>
      <div id="result"></div>

      <div class="counter-box text-center">
        <div>✅ Billets valides : <span id="countValid">0</span></div>
        <div>⚠️ Déjà utilisés : <span id="countUsed">0</span></div>
        <div>📊 Total scannés : <span id="countTotal">0</span></div>
      </div>

      <h5 class="mt-4 text-center">Historique des billets scannés :</h5>
      <ul id="usedList" class="list-group w-75 mx-auto"></ul>
      <div class="text-center mt-3">
        <button class="btn btn-warning" id="resetUsed">🔐 Réinitialiser</button>
        <button class="btn btn-outline-success" id="exportCSV">📤 Exporter CSV</button>
      </div>
    </div>
  </div>
</div>

<!-- Popup code -->
<div id="accessPopup">
  <div class="popup-content">
    <h5>🔐 Code d’accès requis</h5>
    <input type="password" id="popupCode" placeholder="Entrez le code">
    <div>
      <button id="popupConfirm" class="btn btn-success btn-sm">Valider</button>
      <button id="popupCancel" class="btn btn-danger btn-sm">Annuler</button>
    </div>
  </div>
</div>

<!-- Sons -->
<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="codeSuccess" src="https://actions.google.com/sounds/v1/cartoon/ting.ogg"></audio>
<audio id="codeError" src="https://actions.google.com/sounds/v1/cartoon/boing.ogg"></audio>

<script>
const ACCESS_CODES = { pdf:"ARTD2025", reset:"RESET2025", csv:"CSV2025" };
const TOURNAMENT_NAME = "ARTD 3ème Édition 2025";

const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const usedList = document.getElementById('usedList');
const codeSuccess = document.getElementById('codeSuccess');
const codeError = document.getElementById('codeError');
let stream = null, scanInterval = null;

function getUsed(){ return JSON.parse(localStorage.getItem('usedTickets')||'[]'); }
function saveUsed(arr){ localStorage.setItem('usedTickets', JSON.stringify(arr)); }

function markUsed(num, status){
  const arr = getUsed();
  if(!arr.some(t => t.num === num)){
    arr.push({ num, status, time: new Date().toLocaleString() });
    saveUsed(arr);
    renderUsed();
  }
}

function renderUsed(){
  const arr = getUsed();
  usedList.innerHTML = '';
  arr.forEach(({num, status, time})=>{
    const li = document.createElement('li');
    li.textContent = `Billet #${num} - ${status} (${time})`;
    li.className = "list-group-item";
    if(status==="Confirmé") li.classList.add("list-group-item-success");
    else if(status==="Déjà utilisé") li.classList.add("list-group-item-warning");
    else li.classList.add("list-group-item-danger");
    usedList.appendChild(li);
  });
  document.getElementById('countTotal').textContent = arr.length;
  document.getElementById('countValid').textContent = arr.filter(x=>x.status==="Confirmé").length;
  document.getElementById('countUsed').textContent = arr.filter(x=>x.status==="Déjà utilisé").length;
}
renderUsed();

// --- Popup fonctionnel ---
function showAccessPopup(type){
  return new Promise((resolve)=>{
    const popup = document.getElementById('accessPopup');
    const input = document.getElementById('popupCode');
    popup.classList.add('show');
    input.value = '';
    input.focus();

    const confirmHandler = ()=>{
      popup.classList.remove('show');
      if(input.value === ACCESS_CODES[type]){
        codeSuccess.play();
        resolve(true);
      } else {
        codeError.play();
        alert("❌ Code incorrect !");
        resolve(false);
      }
      cleanup();
    };
    const cancelHandler = ()=>{
      popup.classList.remove('show');
      resolve(false);
      cleanup();
    };
    function cleanup(){
      document.getElementById('popupConfirm').removeEventListener('click', confirmHandler);
      document.getElementById('popupCancel').removeEventListener('click', cancelHandler);
    }

    document.getElementById('popupConfirm').addEventListener('click', confirmHandler);
    document.getElementById('popupCancel').addEventListener('click', cancelHandler);
  });
}

// --- PDF ---
document.getElementById('genPDF').addEventListener('click', async ()=>{
  if(!(await showAccessPopup("pdf"))) return;
  const qty = parseInt(document.getElementById('qty').value || 20);
  if(qty<=0){ alert("Veuillez entrer un nombre valide"); return; }
  generatePDF(qty);
});

async function generatePDF(qty){
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({unit:"pt", format:"a4"});
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 30, cols = 2, rows = 5;
  const cellW = (pageWidth - margin*2) / cols;
  const cellH = (pageHeight - margin*2) / rows;
  let count = 0;

  for(let i=1;i<=qty;i++){
    const ticketText = `${TOURNAMENT_NAME} - Billet #${i}`;
    const canvas = document.createElement('canvas');
    await QRCode.toCanvas(canvas, ticketText, {width:100, height:100});
    const col = count % cols;
    const row = Math.floor(count / cols) % rows;
    const x = margin + col*cellW;
    const y = margin + row*cellH;

    pdf.setFillColor(245,255,250);
    pdf.roundedRect(x+5,y+5,cellW-10,cellH-10,10,10,'F');
    pdf.roundedRect(x+5,y+5,cellW-10,cellH-10,10,10,'S');
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',x+cellW/2-50,y+20,100,100);
    pdf.setFontSize(12);
    pdf.text(ticketText,x+cellW/2,y+cellH-30,{align:"center"});

    count++;
    if(count % (cols*rows) === 0 && i<qty){ pdf.addPage(); count=0; }
  }
  pdf.save('billets_tournoi.pdf');
}

// --- Reset ---
document.getElementById('resetUsed').addEventListener('click', async ()=>{
  if(!(await showAccessPopup("reset"))) return;
  if(confirm("Voulez-vous effacer tout l'historique ?")){
    localStorage.removeItem('usedTickets');
    renderUsed();
    resultDiv.textContent='';
    alert("✅ Historique réinitialisé !");
  }
});

// --- Export CSV ---
document.getElementById('exportCSV').addEventListener('click', async ()=>{
  if(!(await showAccessPopup("csv"))) return;
  const arr = getUsed();
  if(arr.length===0){ alert("Aucun billet scanné"); return; }
  const rows = ["Numéro,Statut,Date/Heure"];
  arr.forEach(t=> rows.push(`${t.num},${t.status},${t.time}`));
  const blob = new Blob([rows.join('\n')], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'historique_scans.csv';
  a.click();
});

// --- Scanner QR ---
document.getElementById('startCam').addEventListener('click', async ()=>{
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' } });
    video.srcObject = stream;
    await video.play();
    document.getElementById('startCam').disabled = true;
    document.getElementById('stopCam').disabled = false;

    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    scanInterval = setInterval(()=>{
      if(video.readyState !== video.HAVE_ENOUGH_DATA) return;
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const code = jsQR(ctx.getImageData(0,0,canvas.width,canvas.height).data, canvas.width, canvas.height);
      if(code) handleScan(code.data);
    },150);
  }catch(err){ alert("❌ Impossible d'accéder à la caméra : "+err.message); console.error(err);}
});

document.getElementById('stopCam').addEventListener('click', ()=>{
  clearInterval(scanInterval);
  if(stream) stream.getTracks().forEach(track=>track.stop());
  video.srcObject=null;
  document.getElementById('startCam').disabled=false;
  document.getElementById('stopCam').disabled=true;
});

// --- Validation QR ---
function handleScan(data){
  resultDiv.className="mt-2 text-center fw-bold";
  const match = data.match(/Billet #(\d+)/);
  if(!match){
    resultDiv.classList.add('text-danger');
    resultDiv.textContent="❌ Billet invalide";
    markUsed("Inconnu","Invalide");
    return;
  }
  const num = parseInt(match[1]);
  const arr = getUsed();

  if(arr.some(t=>t.num===num && t.status==="Confirmé")){
    resultDiv.classList.add('text-warning');
    resultDiv.textContent=`⚠️ Billet #${num} déjà utilisé`;
    markUsed(num,"Déjà utilisé");
    return;
  }

  markUsed(num,"Confirmé");
  resultDiv.classList.add('text-success');
  resultDiv.textContent=`✅ Billet #${num} confirmé`;
  document.getElementById('successSound').play();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
