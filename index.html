<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billets Tournoi - Scan Unique</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
<style>
video {
  width: 400px; height: 400px;  /* Taille ajustée */
  border: 3px solid #198754;
  border-radius: 8px;
  display: block; margin: 10px auto;
  object-fit: cover;
}

#result {
  font-size: 2rem;  /* Texte lisible */
  font-weight: bold;
  text-align: center;
  margin-top: 10px;
}
</style>
</head>
<body class="p-3">
<div class="container">
<h2 class="text-center mb-4">Billets Tournoi - Scan Unique</h2>

<ul class="nav nav-tabs justify-content-center">
  <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#emetteur">Émetteur</button></li>
  <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#valideur">Valideur</button></li>
</ul>

<div class="tab-content mt-3">
  <!-- Génération PDF -->
  <div class="tab-pane fade show active" id="emetteur">
    <h4>Générer PDF de billets</h4>
    <input type="number" id="qty" class="form-control mb-2 w-50 mx-auto" placeholder="Nombre de billets" value="20">
    <button id="genPDF" class="btn btn-success mb-3">Générer et Télécharger PDF</button>
  </div>

  <!-- Validation / Scan -->
  <div class="tab-pane fade" id="valideur">
    <h4>Scanner Billets</h4>
    <button class="btn btn-primary mb-2" id="startCam">Démarrer caméra</button>
    <button class="btn btn-danger mb-2" id="stopCam" disabled>Arrêter caméra</button>
    <video id="video"></video>
    <div id="result" class="mt-2 text-center"></div>
    <h5 class="mt-3">Billets déjà scannés :</h5>
    <ul id="usedList" class="list-group w-50 mx-auto"></ul>
    <button class="btn btn-warning mt-3" id="resetUsed">Réinitialiser l'historique</button>
  </div>
</div>
</div>

<!-- Son de confirmation -->
<audio id="successSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>

<script>
const TOURNAMENT_NAME = "ARTD 3ème Edition 2025"; 
let tickets = [];
const video = document.getElementById('video');
const resultDiv = document.getElementById('result');
const usedList = document.getElementById('usedList');
let stream = null;
let scanInterval = null;

// --- Gestion billets scannés ---
function getUsed(){ return JSON.parse(localStorage.getItem('usedTickets')||'[]'); }
function markUsed(num){
  const arr = getUsed();
  if(!arr.includes(num)){
    arr.push(num);
    localStorage.setItem('usedTickets', JSON.stringify(arr));
    renderUsed();
  }
}
function renderUsed(){
  usedList.innerHTML = '';
  getUsed().forEach(num => {
    const li = document.createElement('li');
    li.textContent = "Billet #" + num;
    li.className = "list-group-item";
    usedList.appendChild(li);
  });
}
renderUsed();

// --- Réinitialiser l'historique ---
document.getElementById('resetUsed').addEventListener('click', ()=>{
  if(confirm("Voulez-vous vraiment réinitialiser tous les billets scannés ?")){
    localStorage.removeItem('usedTickets');
    renderUsed();
    resultDiv.innerHTML = '';
  }
});

// --- Génération PDF ---
async function generatePDF(qty){
  const { jsPDF } = window.jspdf;
  tickets = [];
  const pdf = new jsPDF({unit:"pt", format:"a4"}); 
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  const margin = 30, cols = 2, rows = 5;
  const cellW = (pageWidth - margin*2) / cols;
  const cellH = (pageHeight - margin*2) / rows;

  let count = 0;
  for(let i=1;i<=qty;i++){
    const ticketText = `${TOURNAMENT_NAME} - Billet #${i}`;
    tickets.push(i);

    const canvas = document.createElement('canvas');
    await QRCode.toCanvas(canvas, ticketText, {width:100, height:100});

    const col = count % cols;
    const row = Math.floor(count / cols) % rows;
    const x = margin + col*cellW;
    const y = margin + row*cellH;

    pdf.setFillColor(245, 255, 250);
    pdf.roundedRect(x+5, y+5, cellW-10, cellH-10, 10, 10, 'F');
    pdf.setDrawColor(0);
    pdf.roundedRect(x+5, y+5, cellW-10, cellH-10, 10, 10, 'S');

    pdf.addImage(canvas.toDataURL('image/png'), 'PNG', x + cellW/2 - 50, y + 20, 100, 100);
    pdf.setFontSize(12);
    pdf.text(ticketText, x + cellW/2, y + cellH - 30, {align:"center"});

    count++;
    if(count % (cols*rows) === 0 && i<qty){ pdf.addPage(); count=0; }
  }
  pdf.save('billets_tournoi.pdf');
}

document.getElementById('genPDF').addEventListener('click', ()=>{
  const qty = parseInt(document.getElementById('qty').value || 20);
  if(qty<=0){ alert("Veuillez entrer un nombre valide"); return; }
  generatePDF(qty);
});

// --- Scanner QR code ---
document.getElementById('startCam').addEventListener('click', async ()=>{
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  video.srcObject = stream; video.play();
  document.getElementById('startCam').disabled = true;
  document.getElementById('stopCam').disabled = false;

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');

  scanInterval = setInterval(()=>{
    if(video.readyState !== video.HAVE_ENOUGH_DATA) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if(code){ handleScan(code.data); }
  }, 250);
});

document.getElementById('stopCam').addEventListener('click', ()=>{
  clearInterval(scanInterval);
  if(stream) stream.getTracks().forEach(t => t.stop());
  video.srcObject = null;
  document.getElementById('startCam').disabled = false;
  document.getElementById('stopCam').disabled = true;
});

// --- Validation par numéro avec couleurs ---
function handleScan(data){
  resultDiv.className = "mt-2 text-center";

  const match = data.match(/Billet #(\d+)/);
  if(!match){
    resultDiv.classList.add('text-danger');
    resultDiv.textContent = "Billet invalide";
    resultDiv.style.fontSize = "2rem";
    resultDiv.style.fontWeight = "bold";
    return;
  }
  const num = parseInt(match[1]);

  if(getUsed().includes(num)){
    resultDiv.classList.add('text-warning');
    resultDiv.textContent = `Billet #${num} : Billet utilisé`;
    resultDiv.style.fontSize = "2rem";
    resultDiv.style.fontWeight = "bold";
    return;
  }

  markUsed(num);
  resultDiv.classList.add('text-success');
  resultDiv.textContent = `Billet #${num} : Confirmé`;
  resultDiv.style.fontSize = "2rem";
  resultDiv.style.fontWeight = "bold";
  document.getElementById('successSound').play();
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
